---
# playbooks/lxc/diagnostics.yml
# Collect diagnostic information from LXC containers

- name: Collect Diagnostics
  hosts: all
  become: true
  gather_facts: true
  vars:
    ansible_user: maintainer

  tasks:
    - name: Get system uptime
      ansible.builtin.command: uptime -p
      register: uptime_info
      changed_when: false

    - name: Get memory usage
      ansible.builtin.command: free -h
      register: memory_info
      changed_when: false

    - name: Get disk usage
      ansible.builtin.command: df -h /
      register: disk_info
      changed_when: false

    - name: Check failing systemd units
      ansible.builtin.command: systemctl list-units --state=failed --no-legend
      register: failed_units
      changed_when: false

    - name: Get Docker container status
      ansible.builtin.command: docker ps --format "table {{ '{{' }}.Names{{ '}}' }}\t{{ '{{' }}.Status{{ '}}' }}\t{{ '{{' }}.Image{{ '}}' }}"
      register: docker_ps
      ignore_errors: true
      changed_when: false

    - name: Display diagnostic report
      ansible.builtin.debug:
        msg:
          - 'ðŸ“Š Diagnostic Report for {{ inventory_hostname }}'
          - '----------------------------------------'
          - 'UPTIME: {{ uptime_info.stdout }}'
          - ''
          - 'MEMORY:'
          - '{{ memory_info.stdout_lines | indent(2) }}'
          - ''
          - 'DISK:'
          - '{{ disk_info.stdout_lines | indent(2) }}'
          - ''
          - "FAILED UNITS: {{ 'None' if failed_units.stdout == '' else failed_units.stdout_lines | length }}"
          - "{{ failed_units.stdout_lines | indent(2) if failed_units.stdout != '' else '' }}"
          - ''
          - 'DOCKER CONTAINERS:'
          - "{{ docker_ps.stdout_lines | indent(2) if docker_ps.rc == 0 else '  Docker not installed or not running' }}"
          - '----------------------------------------'
